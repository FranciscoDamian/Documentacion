<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>controllers/gerente/EmpleadoController.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AreaController.html">AreaController</a><ul class='methods'><li data-type='method'><a href="AreaController.html#.getAll">getAll</a></li></ul></li><li><a href="AvalesController.html">AvalesController</a><ul class='methods'><li data-type='method'><a href="AvalesController.html#.createOne">createOne</a></li><li data-type='method'><a href="AvalesController.html#.deleteOne">deleteOne</a></li><li data-type='method'><a href="AvalesController.html#.getOne">getOne</a></li><li data-type='method'><a href="AvalesController.html#.updateOne">updateOne</a></li></ul></li><li><a href="BeneficiarioController.html">BeneficiarioController</a><ul class='methods'><li data-type='method'><a href="BeneficiarioController.html#.createOne">createOne</a></li><li data-type='method'><a href="BeneficiarioController.html#.getOne">getOne</a></li><li data-type='method'><a href="BeneficiarioController.html#.updateOne">updateOne</a></li></ul></li><li><a href="ClientesController.html">ClientesController</a><ul class='methods'><li data-type='method'><a href="ClientesController.html#.createClient">createClient</a></li><li data-type='method'><a href="ClientesController.html#.getClient">getClient</a></li><li data-type='method'><a href="ClientesController.html#.getData">getData</a></li><li data-type='method'><a href="ClientesController.html#.updateClient">updateClient</a></li></ul></li><li><a href="ConsultarCuentaController.html">ConsultarCuentaController</a><ul class='methods'><li data-type='method'><a href="ConsultarCuentaController.html#.getAllCuentas">getAllCuentas</a></li><li data-type='method'><a href="ConsultarCuentaController.html#.getPeriodo">getPeriodo</a></li></ul></li><li><a href="CreditoHipotecarioController.html">CreditoHipotecarioController</a><ul class='methods'><li data-type='method'><a href="CreditoHipotecarioController.html#.createOne">createOne</a></li><li data-type='method'><a href="CreditoHipotecarioController.html#.createOne">createOne</a></li><li data-type='method'><a href="CreditoHipotecarioController.html#.getOne">getOne</a></li></ul></li><li><a href="CuentasController.html">CuentasController</a><ul class='methods'><li data-type='method'><a href="CuentasController.html#.createCredit">createCredit</a></li><li data-type='method'><a href="CuentasController.html#.createDebit">createDebit</a></li><li data-type='method'><a href="CuentasController.html#.getAll">getAll</a></li><li data-type='method'><a href="CuentasController.html#.getOne">getOne</a></li><li data-type='method'><a href="CuentasController.html#.updateOne">updateOne</a></li></ul></li><li><a href="DataController.html">DataController</a><ul class='methods'><li data-type='method'><a href="DataController.html#.getData">getData</a></li></ul></li><li><a href="DepositarController.html">DepositarController</a><ul class='methods'><li data-type='method'><a href="DepositarController.html#.updateOne">updateOne</a></li></ul></li><li><a href="DineroDisponibleController.html">DineroDisponibleController</a><ul class='methods'><li data-type='method'><a href="DineroDisponibleController.html#.getAll">getAll</a></li></ul></li><li><a href="EmpleadoController.html">EmpleadoController</a><ul class='methods'><li data-type='method'><a href="EmpleadoController.html#.create">create</a></li><li data-type='method'><a href="EmpleadoController.html#.getAll">getAll</a></li><li data-type='method'><a href="EmpleadoController.html#.getOne">getOne</a></li><li data-type='method'><a href="EmpleadoController.html#.login">login</a></li><li data-type='method'><a href="EmpleadoController.html#.update">update</a></li></ul></li><li><a href="ReponerTarjetaController.html">ReponerTarjetaController</a><ul class='methods'><li data-type='method'><a href="ReponerTarjetaController.html#.updateOne">updateOne</a></li></ul></li><li><a href="RetirarController.html">RetirarController</a><ul class='methods'><li data-type='method'><a href="RetirarController.html#.updateOne">updateOne</a></li></ul></li><li><a href="RoleController.html">RoleController</a><ul class='methods'><li data-type='method'><a href="RoleController.html#.getAll">getAll</a></li></ul></li><li><a href="SucursalController.html">SucursalController</a><ul class='methods'><li data-type='method'><a href="SucursalController.html#.getAll">getAll</a></li></ul></li><li><a href="TransaccionController.html">TransaccionController</a><ul class='methods'><li data-type='method'><a href="TransaccionController.html#.getAll">getAll</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-api.html">api</a></li><li><a href="module-utils.bncrypt.utils.module_bncrypt.html">bncrypt</a><ul class='methods'><li data-type='method'><a href="module-utils.bncrypt.utils.module_bncrypt.html#.hashPassword">hashPassword</a></li><li data-type='method'><a href="module-utils.bncrypt.utils.module_bncrypt.html#.verifyPassword">verifyPassword</a></li></ul></li><li><a href="utils.module_sequelizeOptions.html">sequelizeOptions</a><ul class='methods'><li data-type='method'><a href="utils.module_sequelizeOptions.html#.filter">filter</a></li><li data-type='method'><a href="utils.module_sequelizeOptions.html#.pageLimit">pageLimit</a></li><li data-type='method'><a href="utils.module_sequelizeOptions.html#.paginate">paginate</a></li></ul></li><li><a href="utils.module_tokenGenerator.html">tokenGenerator</a><ul class='methods'><li data-type='method'><a href="utils.module_tokenGenerator.html#~token_">token_</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">controllers/gerente/EmpleadoController.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * CRUD for Empleados.
 * @class EmpleadoController
 * */
const { ok, notFound, internalError } = require('../../helpers/statusCodes')
const { errorHandler, error400Handler } = require('../../helpers/errorHelper')
const { Empleados, Sucursales, Areas, Roles, } = require('../../models')
const { pageLimit, paginate, filter } = require('../../utils/sequelizeOptions')
const tokenGenerator = require('../../utils/tokenGenerator')
const bcrypt = require('../../utils/bcrypt')

/** 
 * Do a session or login sending username and password.
 * @function login
 * @memberOf EmpleadoController
 * @name login
 * @param {Request} req - Request.
 * @param {Response} res - Response.
 * @param {Middleware} next - Middleware next method.
 * @param {string} req.body.username - Username registered for this user in database.
 * @param {string} req.body.password - Password registered for this user in database.
 * @return {Response} res - Response.
 * */
exports.login = async (req, res, next) => {
    try {
        const {
            username,
            password
        } = req.body

        const login = await Empleados.findOne({
            where: {
                username: username,
            },
            attributes: ["id", "username", "password", "RoleId", "nombre", "apellido"]
        })

        await bcrypt.verifyPassword(password, login.password)

        delete login.dataValues.password
        const token = await tokenGenerator({
            ...login.dataValues
        })

        return res.status(ok).json({
            message: `Peticion exitosa`,
            status: ok,
            success: {
                ...login.dataValues,
                token,
            }
        })
    } catch (error) {
        // next(error)
        return res.status(400).json(errorHandler(error))
    }
}

/** 
 * Do request to the Empleados table and obtain all of them through filters that can be empty.
 * @function getAll
 * @memberOf EmpleadoController
 * @param {Request} req - Request.
 * @param {Response} res - Response.
 * @param {Middleware} next - Middleware next method.
 * @param {string} [req.query.page=0] - Current page.
 * @param {string} [req.query.amount=10] - quantity of records.
 * @param {string} [req.query.sort=null] - DESC or ASC or null.
 * @param {string} [req.query.role=null] - Role id.
 * @param {string} [req.query.search=null] - fragment of employee's name.
 * @return {Response} res - Response.
 * */
exports.getAll = async (req, res, next) => {
    try {
        const {
            page = 0, amount = 10, sort, role, search
        } = req.query
        const where = await filter(search, role)
        const {
            rows: employees,
            count
        } = await Empleados.findAndCountAll({
            where: {
                ...where
            },
            attributes: { exclude: ['password', 'createdAt', 'updatedAt'] },
            ...(await pageLimit(page, amount, sort))
        })
        const pagination = await paginate(count, page, amount)

        return res.status(ok).json({
            message: `Peticion exitosa`,
            status: ok,
            success: {
                page,
                ...pagination,
                count,
                employees
            }
        })
    } catch (error) {
        // next(error)
        return res.status(400).json(errorHandler(error))
    }
}

/** 
 * Get details for one employee.
 * @function getOne
 * @memberOf EmpleadoController
 * @param {Request} req - Request.
 * @param {Response} res - Response.
 * @param {Middleware} next - Middleware next method.
 * @param {string} req.query.id - Role id.
 * @return {Response} res - Response.
 * */
exports.getOne = async (req, res, next) => {
    try {
        const {
            id
        } = req.params
        const empleado = await Empleados.findByPk(id, {
            attributes: { exclude: ['password'] },
            include: [
                {
                    model: Areas,
                    attributes: ["id", "nombre"],
                },
                {
                    model: Sucursales,
                    as: "Sucursal",
                    attributes: { exclude: ['createdAt', 'updatedAt'] }
                },
                {
                    model: Roles,
                    as: "Role",
                    attributes: ["id", "nombre"]
                },

            ]
        })
        if (empleado == null) return res.status(notFound).json(error400Handler({ x: 0 }))

        return res.status(ok).json({
            message: `Peticion exitosa`,
            status: ok,
            success: empleado
        })
    } catch (error) {
        // next(error)
        return res.status( internalError ).json(errorHandler(error))
    }
}

/** 
 * Create a new employee.
 * @function create
 * @memberOf EmpleadoController
 * @param {Request} req - Request.
 * @param {Response} res - Response.
 * @param {Middleware} next - Middleware next method.
 * @param {String} req.body.nombre - Employee's name.
 * @param {String} req.body.apellido - Employee's lastname.
 * @param {Boolean} req.body.status - Employee's status.
 * @param {String} req.body.username - Employee's username.
 * @param {String} req.body.email - Employee's email.
 * @param {String} req.body.password - Employee's password.
 * @param {Number} req.body.AreaId - Area destinated to this employee.
 * @param {Number} req.body.SucursalId - Sucursal destinated to this employee.
 * @param {Number} req.body.RoleId - Role destinated to this employee.
 * @return {Response} res - Response.
 * */
exports.create = async (req, res, next) => {
    try {
        const empleadoData = {
            nombre: req.body.nombre,
            apellido: req.body.apellido,
            status: req.body.status,
            AreaId: req.body.AreaId,
            SucursalId: req.body.SucursalId,
            RoleId: req.body.RoleId,
            username: req.body.username,
            email: req.body.email,
            password: await bcrypt.hashPassword(req.body.password),
        }
        const nuevoEmpleado = await Empleados.build(empleadoData)
        await nuevoEmpleado.save()
        const { id } = nuevoEmpleado
        const empleado = await Empleados.findByPk(id, {
            attributes: { exclude: ['password'] }
        })
        if (empleado == null) return res.status(notFound).json(error400Handler({ x: 0 }))

        res.status(ok).json({
            message: `Se ingreso un nuevo empleado de manera exitosa`,
            status: ok,
            success: {
                empleado
            }
        })
    } catch (error) {
        // next(error)
        return res.status( internalError ).json(errorHandler(error))
    }
}

/** 
 * Edit an employee.
 * @function update
 * @memberOf EmpleadoController
 * @param {Request} req - Request.
 * @param {Response} res - Response.
 * @param {Middleware} next - Middleware next method.
 * @param {String} req.body.nombre - Employee's name.
 * @param {String} req.body.apellido - Employee's lastname.
 * @param {Boolean} req.body.status - Employee's status.
 * @param {String} req.body.username - Employee's username.
 * @param {String} req.body.email - Employee's email.
 * @param {String} req.body.password - Employee's password.
 * @param {Number} req.body.AreaId - Area destinated to this employee.
 * @param {Number} req.body.SucursalId - Sucursal destinated to this employee.
 * @param {Number} req.body.RoleId - Role destinated to this employee.
 * @param {Number} req.body.RoleId - Role destinated to this employee.
 * @return {Response} res - Response.
 * */
exports.updateOne = async (req, res, next) => {
    try {

        const { id } = req.params
        if (id == 1) {
            delete req.body['RoleId']
            delete req.body['username']
            delete req.body['password']
            delete req.body['email']
        }
        const success = await Empleados.update({
            ...req.body
        }, {
            where: { 
                id
             },
            include: [
                { model: Sucursales },
                { model: Roles}
            ]
        })
        if (success[0] == 0) return res.status(notFound).json(error400Handler({ x: 0 }))

        return res.status(ok).json({
            message: `Se actualizo el empleado de manera exitosa`,
            status: ok,
        })
    } catch (error) {
        return res.status(internalError).json(errorHandler(error))
        // next(error)
    }
}

exports.deleteOne = async (req, res, next) => {
    try {
        const { id } = req.params
        if (id==1) return res.status(notFound).json(error400Handler({ x: 0 }))
        const empleado = await Empleados.findByPk(id)
        if (empleado == null) return res.status(notFound).json(error400Handler({ x: 0 }))

        const destroyedEmployee = await empleado.destroy()

        return res.status(ok).json({
            message: `Peticion exitosa`,
            status: ok,
            success: destroyedEmployee
        })
    } catch (error) {
        // next(error)
        return res.status(internalError).json(errorHandler(error))
    }
}</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.10</a> on Thu Apr 28 2022 13:33:32 GMT-0500 (Central Daylight Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
